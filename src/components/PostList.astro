---
import DateFormatter from "./DateFormatter.astro";
import ViewCount from "./ViewCount.astro";
import ButtonLink from "./ButtonLink.astro";
import type { GhostPost, Views } from "../types/types";
import {
  isExternal,
  computeDescription,
  extractUrlFromBookmark,
  extractHostFromUrl,
} from "../lib/ContentService";
import analyticsService from "../lib/AnalyticsService";

interface Props {
  posts: GhostPost[];
}

const { posts } = Astro.props;
const viewMap = await analyticsService.makePageViewMap(posts);
---

<ul class="space-y-10">
  {
    posts.map((post) => {
      const description = computeDescription(post);
      const external = isExternal(post);
      const postPath = external
        ? extractUrlFromBookmark(post.html)
        : `/posts/${post.slug}`;
      const target = external ? "_blank" : "_self";
      const [viewStr, viewNum] = viewMap.get(post.slug) as Views;

      return (
        <li>
          <article>
            <h2 class="text-2xl font-bold">
              <a href={postPath} target={target}>
                {post.title}
              </a>
            </h2>

            <div class="flex flex-wrap items-center mb-3 gap-x-3 text-base text-gray-500">
              <DateFormatter
                date={post.published_at}
                className="inline-block"
              />

              {viewNum > 200 || external ? <small>/</small> : null}

              {external ? (
                extractHostFromUrl(postPath)
              ) : (
                <>
                  {viewNum > 200 && (
                    <ViewCount
                      value={viewStr}
                      slug={post.slug}
                      disableAnimation={true}
                    />
                  )}
                </>
              )}
            </div>

            <p class="block text-gray-500 mb-2">{description}</p>

            <ButtonLink href={postPath} target={target} withArrow={true}>
              Read It
            </ButtonLink>
          </article>
        </li>
      );
    })
  }
</ul>
